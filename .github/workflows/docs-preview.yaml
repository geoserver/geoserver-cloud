name: Documentation Preview

on:
  pull_request_target:
    branches: [ main ]
    paths:
      - 'docs/**'
      - '.github/workflows/docs-preview.yaml'
  workflow_dispatch:
    inputs:
      branch_name:
        description: 'Branch name for preview'
        required: false
        default: ''

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  # Security check for fork PRs - skipped for same-repo PRs
  security-check:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request_target'
    outputs:
      is_fork: ${{ steps.check.outputs.is_fork }}
      safe: ${{ steps.check.outputs.safe || steps.security.outputs.safe }}
    steps:
      - name: Check if PR is from fork
        id: check
        run: |
          if [ "${{ github.event.pull_request.head.repo.full_name }}" != "${{ github.repository }}" ]; then
            echo "is_fork=true" >> $GITHUB_OUTPUT
            echo "üîç Fork PR detected - will run security checks"
          else
            echo "is_fork=false" >> $GITHUB_OUTPUT
            echo "‚úÖ Same-repo PR - security checks skipped (trusted)"
            echo "safe=true" >> $GITHUB_OUTPUT
            exit 0
          fi

      - name: Checkout base branch
        if: steps.check.outputs.is_fork == 'true'
        uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}
          fetch-depth: 0

      - name: Fetch PR
        if: steps.check.outputs.is_fork == 'true'
        run: |
          git fetch origin +refs/pull/${{ github.event.pull_request.number }}/head:refs/remotes/origin/pr-${{ github.event.pull_request.number }}

      - name: Check for dangerous file changes
        id: security
        if: steps.check.outputs.is_fork == 'true'
        run: |
          # Get list of changed files between base and PR
          CHANGED_FILES=$(git diff --name-only ${{ github.base_ref }}...origin/pr-${{ github.event.pull_request.number }})

          echo "Changed files:"
          echo "$CHANGED_FILES"
          echo ""

          # Define patterns for dangerous files
          DANGEROUS_PATTERNS=(
            '\.sh$'                    # Shell scripts
            '^\.github/workflows/'     # Workflow files
            'Makefile$'                # Makefiles
            'Dockerfile'               # Dockerfiles
            '\.py$'                    # Python scripts (build scripts)
            'requirements\.txt$'       # Dependencies (blocks new plugins)
          )

          # Note: mkdocs.yml is allowed because:
          # - requirements.txt is blocked (can't install malicious plugins)
          # - .py files are blocked (can't add custom hooks/code)
          # - Most changes are just nav/metadata updates

          # Check each changed file
          SAFE=true
          while IFS= read -r file; do
            # Skip empty lines
            [ -z "$file" ] && continue

            # Check against dangerous patterns
            for pattern in "${DANGEROUS_PATTERNS[@]}"; do
              if echo "$file" | grep -qE "$pattern"; then
                echo "‚ö†Ô∏è  UNSAFE: $file matches dangerous pattern: $pattern"
                SAFE=false
              fi
            done
          done <<< "$CHANGED_FILES"

          if [ "$SAFE" = "true" ]; then
            echo "‚úÖ All changed files are safe (markdown, images, CSS only)"
            echo "safe=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Dangerous files detected - preview deployment skipped for security"
            echo "safe=false" >> $GITHUB_OUTPUT
          fi

  build-preview:
    runs-on: ubuntu-latest
    needs: security-check
    # Run if: manual dispatch, OR (it's a PR and either same-repo or passed security check)
    if: |
      github.event_name == 'workflow_dispatch' ||
      (needs.security-check.outputs.is_fork == 'false') ||
      (needs.security-check.outputs.is_fork == 'true' && needs.security-check.outputs.safe == 'true')

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.inputs.branch_name || github.event.pull_request.head.sha || github.head_ref }}

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        cache-dependency-path: 'docs/requirements.txt'

    - name: Set up Docker for diagrams
      uses: docker/setup-buildx-action@v3

    - name: Build Documentation Preview
      working-directory: docs
      run: |
        # Calculate Preview URL and Banner
        if [ "${{ github.event_name }}" = "pull_request_target" ]; then
          SITE_URL="https://geoserver.org/geoserver-cloud/preview/pr-${{ github.event.pull_request.number }}/"
          BANNER='üößüß™ This is a preview build for <a href="https://github.com/geoserver/geoserver-cloud/pull/${{ github.event.pull_request.number }}" style="color: white; text-decoration: underline; font-weight: bold;">PR #${{ github.event.pull_request.number }}</a>'
        else
          BRANCH_NAME="${{ github.event.inputs.branch_name || github.ref_name }}"
          SAFE_BRANCH_NAME=$(echo "$BRANCH_NAME" | sed 's/[^a-zA-Z0-9-]/-/g')
          SITE_URL="https://geoserver.org/geoserver-cloud/preview/branch-${SAFE_BRANCH_NAME}/"
          BANNER="üößüß™ This is a preview build for branch: ${BRANCH_NAME}"
        fi

        # Export environment variables for build script
        export SITE_URL
        export BANNER_MESSAGE="$BANNER"

        # Build with preview settings
        ./build.sh "$SITE_URL" "$BANNER_MESSAGE"

    - name: Set preview path
      id: preview-path
      run: |
        if [ "${{ github.event_name }}" = "pull_request_target" ]; then
          echo "path=preview/pr-${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          echo "name=pr-${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
        else
          BRANCH_NAME="${{ github.event.inputs.branch_name || github.ref_name }}"
          SAFE_BRANCH_NAME=$(echo "$BRANCH_NAME" | sed 's/[^a-zA-Z0-9-]/-/g')
          echo "path=preview/branch-${SAFE_BRANCH_NAME}" >> $GITHUB_OUTPUT
          echo "name=branch-${SAFE_BRANCH_NAME}" >> $GITHUB_OUTPUT
        fi

    - name: Deploy to GitHub Pages Preview
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: docs/site
        destination_dir: ${{ steps.preview-path.outputs.path }}
        keep_files: true
        commit_message: 'docs: deploy preview for ${{ steps.preview-path.outputs.name }} [skip ci]'

    - name: Upload preview artifacts
      uses: actions/upload-artifact@v4
      with:
        name: documentation-preview-${{ steps.preview-path.outputs.name }}
        path: docs/site/
        retention-days: 14

    - name: Comment on PR with preview link
      if: github.event_name == 'pull_request_target'
      uses: actions/github-script@v7
      with:
        script: |
          const prNumber = context.payload.pull_request.number;
          const commitSha = context.payload.pull_request.head.sha.substring(0, 7);
          const previewUrl = `https://geoserver.org/geoserver-cloud/preview/pr-${prNumber}/`;
          const artifactUrl = `${context.payload.repository.html_url}/actions/runs/${context.runId}`;
          const isFork = context.payload.pull_request.head.repo.full_name !== context.payload.repository.full_name;

          const securityNote = isFork ? '\n\n### üîí Security Note:\nThis preview was built using safe mode (documentation-only changes).\n' : '';

          const comment = `
          ## üìñ Documentation Preview Ready!

          The documentation has been built for this PR.

          ### üîó [Click here to view the Live Preview](${previewUrl})

          *(Note: It may take a minute for GitHub Pages to update)*

          ### üìä Build Information:
          - **Commit**: \`${commitSha}\`
          - **Status**: ‚úÖ Build Successful
          - **Artifacts**: [Download Build](${artifactUrl})${securityNote}
          ---
          *Generated by GitHub Actions*
          `;

          const existingComments = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: prNumber
          });

          const botComment = existingComments.data.find(comment =>
            comment.user.type === 'Bot' &&
            comment.body.includes('üìñ Documentation Preview Ready!')
          );

          try {
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: comment
              });
            }
          } catch (error) {
            console.log('Could not post/update comment on PR:', error.message);
          }

  notify-unsafe:
    runs-on: ubuntu-latest
    needs: security-check
    if: needs.security-check.outputs.is_fork == 'true' && needs.security-check.outputs.safe == 'false'

    steps:
      - name: Comment on PR about security
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;

            const comment = `
            ## üìñ Documentation Preview Skipped

            This PR modifies executable files or build scripts, so the automatic preview deployment has been skipped for security reasons.

            ### ‚ö†Ô∏è Files that triggered security check:
            - Shell scripts (\`.sh\`)
            - Workflow files (\`.github/workflows/\`)
            - Build configuration (\`Makefile\`, \`requirements.txt\`)
            - Python scripts (\`.py\`)

            ### üìä What happens next:
            - The documentation will still be built and verified
            - A maintainer can manually trigger a preview if needed
            - The docs will be deployed normally once merged to \`main\`

            ---
            *Generated by GitHub Actions*
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: comment
            });

  compare-changes:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request_target'
    needs: security-check

    steps:
    - name: Checkout base branch
      uses: actions/checkout@v4
      with:
        ref: ${{ github.base_ref }}
        path: base

    - name: Checkout PR branch
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.pull_request.head.sha }}
        path: pr

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Set up Docker for diagrams
      uses: docker/setup-buildx-action@v3

    - name: Build base documentation
      run: |
        if [ -d "base/docs" ] && [ -f "base/docs/build.sh" ]; then
          cd base/docs
          ./build.sh
          mv site ../../base-site
        else
          mkdir -p base-site
          echo "<html><body><h1>No documentation in base branch</h1></body></html>" > base-site/index.html
        fi

    - name: Build PR documentation
      working-directory: pr/docs
      run: |
        ./build.sh
        mv site ../../pr-site

    - name: Compare documentation changes
      run: |
        echo "## üìä Documentation Changes Analysis" > /tmp/changes.md
        echo "" >> /tmp/changes.md

        base_files=$(find base-site -name "*.html" | wc -l)
        pr_files=$(find pr-site -name "*.html" | wc -l)

        echo "- **Pages in Base**: $base_files" >> /tmp/changes.md
        echo "- **Pages in PR**: $pr_files" >> /tmp/changes.md
        echo "- **Net Change**: $((pr_files - base_files))" >> /tmp/changes.md
        echo "" >> /tmp/changes.md

        echo "### üÜï New Pages" >> /tmp/changes.md
        new_pages=$(mktemp)
        find pr-site -name "*.html" -type f | while read pr_file; do
          relative_path=${pr_file#pr-site/}
          base_file="base-site/$relative_path"
          if [ ! -f "$base_file" ]; then
            echo "- \`$relative_path\`" >> "$new_pages"
          fi
        done
        if [ -s "$new_pages" ]; then
          cat "$new_pages" >> /tmp/changes.md
        else
          echo "*None*" >> /tmp/changes.md
        fi
        rm -f "$new_pages"

        echo "" >> /tmp/changes.md
        echo "### üóëÔ∏è Removed Pages" >> /tmp/changes.md
        removed_pages=$(mktemp)
        find base-site -name "*.html" -type f | while read base_file; do
          relative_path=${base_file#base-site/}
          pr_file="pr-site/$relative_path"
          if [ ! -f "$pr_file" ]; then
            echo "- \`$relative_path\`" >> "$removed_pages"
          fi
        done
        if [ -s "$removed_pages" ]; then
          cat "$removed_pages" >> /tmp/changes.md
        else
          echo "*None*" >> /tmp/changes.md
        fi
        rm -f "$removed_pages"

    - name: Add comparison to PR comment
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          try {
            const changes = fs.readFileSync('/tmp/changes.md', 'utf8');
            const comment = changes;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: comment
            });
          } catch (error) {
            console.log('Error posting comparison:', error);
          }
