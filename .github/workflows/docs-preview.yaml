name: Documentation Preview

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'docs/**'
      - '.github/workflows/docs-preview.yaml'
  workflow_dispatch:
    inputs:
      branch_name:
        description: 'Branch name for preview'
        required: false
        default: ''

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  build-preview:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event.inputs.branch_name != ''

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.inputs.branch_name || github.event.pull_request.head.sha || github.head_ref }}

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        cache-dependency-path: 'docs/requirements.txt'

    - name: Set up Docker for diagrams
      uses: docker/setup-buildx-action@v3

    - name: Build Documentation Preview
      working-directory: docs
      run: |
        # Calculate Preview URL and Banner
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          SITE_URL="https://geoserver.org/geoserver-cloud/preview/pr-${{ github.event.number }}/"
          BANNER="ðŸ“ This is a preview build for PR #${{ github.event.number }}"
        else
          BRANCH_NAME="${{ github.event.inputs.branch_name || github.ref_name }}"
          SAFE_BRANCH_NAME=$(echo "$BRANCH_NAME" | sed 's/[^a-zA-Z0-9-]/-/g')
          SITE_URL="https://geoserver.org/geoserver-cloud/preview/branch-${SAFE_BRANCH_NAME}/"
          BANNER="ðŸŒ¿ This is a preview build for branch: ${BRANCH_NAME}"
        fi

        # Build with preview settings using Makefile
        make build-preview SITE_URL="$SITE_URL" BANNER_MESSAGE="$BANNER"

    - name: Set preview path
      id: preview-path
      run: |
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          echo "path=preview/pr-${{ github.event.number }}" >> $GITHUB_OUTPUT
          echo "name=pr-${{ github.event.number }}" >> $GITHUB_OUTPUT
        else
          BRANCH_NAME="${{ github.event.inputs.branch_name || github.ref_name }}"
          SAFE_BRANCH_NAME=$(echo "$BRANCH_NAME" | sed 's/[^a-zA-Z0-9-]/-/g')
          echo "path=preview/branch-${SAFE_BRANCH_NAME}" >> $GITHUB_OUTPUT
          echo "name=branch-${SAFE_BRANCH_NAME}" >> $GITHUB_OUTPUT
        fi

    - name: Deploy to GitHub Pages Preview
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: docs/site
        destination_dir: ${{ steps.preview-path.outputs.path }}
        keep_files: true
        commit_message: 'docs: deploy preview for ${{ steps.preview-path.outputs.name }} [skip ci]'

    - name: Upload preview artifacts
      uses: actions/upload-artifact@v4
      with:
        name: documentation-preview-${{ steps.preview-path.outputs.name }}
        path: docs/site/
        retention-days: 14

    - name: Comment on PR with preview link
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const prNumber = context.payload.pull_request.number;
          const commitSha = context.payload.pull_request.head.sha.substring(0, 7);
          const previewUrl = `https://geoserver.org/geoserver-cloud/preview/pr-${prNumber}/`;
          const artifactUrl = `${context.payload.repository.html_url}/actions/runs/${context.runId}`;

          const comment = `
          ## ðŸ“– Documentation Preview Ready!

          The documentation has been built for this PR.

          ### ðŸ”— [Click here to view the Live Preview](${previewUrl})

          *(Note: It may take a minute for GitHub Pages to update)*

          ### ðŸ“Š Build Information:
          - **Commit**: \`${commitSha}\`
          - **Status**: âœ… Build Successful
          - **Artifacts**: [Download Build](${artifactUrl})

          ---
          *Generated by GitHub Actions*
          `;
          
          const existingComments = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: prNumber
          });

          const botComment = existingComments.data.find(comment => 
            comment.user.type === 'Bot' && 
            comment.body.includes('ðŸ“– Documentation Preview Ready!')
          );

          try {
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: comment
              });
            }
          } catch (error) {
            console.log('Could not post/update comment on PR:', error.message);
          }

  compare-changes:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
    - name: Checkout base branch
      uses: actions/checkout@v4
      with:
        ref: ${{ github.base_ref }}
        path: base

    - name: Checkout PR branch
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.pull_request.head.sha }}
        path: pr

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Set up Docker for diagrams
      uses: docker/setup-buildx-action@v3

    - name: Build base documentation
      run: |
        if [ -d "base/docs" ] && [ -f "base/docs/build.sh" ]; then
          cd base/docs
          ./build.sh
          mv site ../../base-site
        else
          mkdir -p base-site
          echo "<html><body><h1>No documentation in base branch</h1></body></html>" > base-site/index.html
        fi

    - name: Build PR documentation
      working-directory: pr/docs
      run: |
        ./build.sh
        mv site ../../pr-site

    - name: Compare documentation changes
      run: |
        echo "## ðŸ“Š Documentation Changes Analysis" > /tmp/changes.md
        echo "" >> /tmp/changes.md

        base_files=$(find base-site -name "*.html" | wc -l)
        pr_files=$(find pr-site -name "*.html" | wc -l)

        echo "- **Pages in Base**: $base_files" >> /tmp/changes.md
        echo "- **Pages in PR**: $pr_files" >> /tmp/changes.md
        echo "- **Net Change**: $((pr_files - base_files))" >> /tmp/changes.md
        echo "" >> /tmp/changes.md

        echo "### ðŸ†• New Pages" >> /tmp/changes.md
        new_pages=$(mktemp)
        find pr-site -name "*.html" -type f | while read pr_file; do
          relative_path=${pr_file#pr-site/}
          base_file="base-site/$relative_path"
          if [ ! -f "$base_file" ]; then
            echo "- \`$relative_path\`" >> "$new_pages"
          fi
        done
        if [ -s "$new_pages" ]; then
          cat "$new_pages" >> /tmp/changes.md
        else
          echo "*None*" >> /tmp/changes.md
        fi
        rm -f "$new_pages"

        echo "" >> /tmp/changes.md
        echo "### ðŸ—‘ï¸ Removed Pages" >> /tmp/changes.md
        removed_pages=$(mktemp)
        find base-site -name "*.html" -type f | while read base_file; do
          relative_path=${base_file#base-site/}
          pr_file="pr-site/$relative_path"
          if [ ! -f "$pr_file" ]; then
            echo "- \`$relative_path\`" >> "$removed_pages"
          fi
        done
        if [ -s "$removed_pages" ]; then
          cat "$removed_pages" >> /tmp/changes.md
        else
          echo "*None*" >> /tmp/changes.md
        fi
        rm -f "$removed_pages"
        
    - name: Add comparison to PR comment
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          try {
            const changes = fs.readFileSync('/tmp/changes.md', 'utf8');
            const comment = changes;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: comment
            });
          } catch (error) {
            console.log('Error posting comparison:', error);
          }
