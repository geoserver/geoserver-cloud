name: Documentation Preview Cleanup

on:
  pull_request_target:
    types: [closed]
    paths:
      - 'docs/**'

permissions:
  contents: write

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          fetch-depth: 1

      - name: Remove preview directory
        run: |
          PREVIEW_DIR="preview/pr-${{ github.event.pull_request.number }}"

          if [ -d "$PREVIEW_DIR" ]; then
            echo "üóëÔ∏è Removing preview directory: $PREVIEW_DIR"
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git rm -rf "$PREVIEW_DIR"
            git commit -m "docs: cleanup preview for closed PR #${{ github.event.pull_request.number }} [skip ci]"
            git push origin gh-pages
            echo "‚úÖ Preview directory removed successfully"
          else
            echo "‚ÑπÔ∏è Preview directory does not exist, nothing to cleanup"
          fi

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const previewUrl = `https://geoserver.org/geoserver-cloud/preview/pr-${prNumber}/`;

            const comment = `
            ## üóëÔ∏è Documentation Preview Cleaned Up

            The preview deployment for this PR has been removed from GitHub Pages.

            Preview URL (now removed): ~~${previewUrl}~~

            ---
            *Generated by GitHub Actions*
            `;

            try {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: comment
              });
            } catch (error) {
              console.log('Could not post comment:', error.message);
            }
